---
title: "Statistical Tools for Large-Scale Spatiotemporal Transportation Data"
author: "Marie Hardt"
date: "2025-10-09"
institute: "Iowa State University"
bibliography: "`r rbbt::bbt_write_bib('slidereferences.bib', keys=rbbt::bbt_detect_citations(here::here('problem_overview.qmd')),
   ignore = stringr::str_subset(rbbt::bbt_detect_citations(here::here('problem_overview.qmd')), '(^fig-|^tbl-|^eq-|^sec-|^lst-|^thm-|^lem-|^cor-|^prp-|^cnj-|^def-|^exm-|^exr-)'), overwrite = TRUE, library_id='Graphics-Research', translator='bibtex')`"
format: 
  revealjs:
    theme: simple
    slide-number: true
---

```{r setup}
#| echo: false
#| warning: false
#| message: false
library(rbbt)
library(tidyverse)
library(leaflet)
library(sf)
library(glue)
# remotes::install_github("hardtme/DrivePlotR)
library(DrivePlotR)
library(tmap)
tmap_mode("plot")
# remotes::install_github("dill/emoGG")
library(emoGG)
library(gpsdriving)
library(fontawesome)

fa_by_name <- function(name, fill = "blue", stroke = "white", stroke_width = "1px") {
  fa_png(
    name = name,
    fill = fill,
    fill_opacity = 1,
    stroke = stroke,
    stroke_width = stroke_width, 
    stroke_opacity = 1,
    height = 512,
    width = 512
  )
}

example_tmap <- function(basemap = "CartoDB.VoyagerNoLabels",
                         road_system,
                         bbox,
                         road_system_color = "tan",
                         road_system_lwd = 10,
                         og_points,
                         og_points_color = "blue",
                         new_points,
                         new_points_color = "red",
                         point_size = 1,
                         point_fill_alpha = 1,
                         match_lines,
                         match_lines_color = "black"){
ex_tmap <- tm_basemap(server = basemap)+
  tm_shape(road_system, bbox = bbox)+
  tm_lines(col = road_system_color, lwd = road_system_lwd)+
  tm_shape(match_lines, bbox = bbox)+
  tm_lines(col = match_lines_color)+
  tm_shape(og_points, bbox = bbox)+
  tm_dots(size = point_size, fill = og_points_color, fill_alpha = point_fill_alpha, 
          group = "original", group.control = "none")+
  tm_shape(new_points, bbox = bbox)+
  tm_dots(size = point_size, fill = new_points_color, fill_alpha = point_fill_alpha,
          group = "shifted", group.control = "none")
return(ex_tmap)
}
```

# Spatiotemporal Transportation Data

## Vehicle Trajectory Data

* Collected from vehicles as they are driven.

* Points observed regularly (e.g., every 1-3 sec. for our data sources).

## Typical Variables

* Location (latitude/longitude).
  
* Speed.
  
* Heading.

* Etc.

## Sources

* Naturalistic driving studies (NDS)

  - Instrumentation installed in study participants' vehicles.

* Connected vehicles

  - Instrumentation built into the vehicle by original manufacturer.

## Use Cases

* Studying driving behavior.

* Driving maneuver detection.

* Work zone impact/performance.

* Etc.

# GPS Data

## Units Are Important!

It's 25 degrees outside today.

* Fahrenheit: ðŸ¥¶

* Celsius: ðŸ˜Ž

## Coordinate Reference System

* Describes how latitude/longitude coordinates relate to real places on the Earth's surface.

* Ensures locations are properly located because they are related to the correct ellipsoidal approximation of the Earth.

* CRS for GPS data: WGS 84.

## Projected Coordinate System

* Projects coordinates from the Earth's surface (3-D) down to 2 dimensions.

* 3-D surfaces can't be projected down to 2 dimensions without distortion (but that's okay).

* Example: WGS 84 Web Mercator projection for coordinates using the WGS 84 projection.

## GPS Overview (Simplified)

* Part of Global Navigation Satellite System (GNSS).

* Satellite constellation orbits the Earth.

* Ground-based monitoring stations track satellites and transmit satellite locations back to the satellites.

* Satellites transmit their positions to receivers.

* Receivers determine the travel time of the signal from the satellite and thus the distance to the satellite. 

## Examples of GPS Satellite Constellation Geometries

:::{layout-ncol=2}

```{r}
#| echo: false
#| fig-cap: "Poor Satellite Geometry"

receiver <- data.frame( x = 0, y = 0)

bad_satellites <- data.frame(x = c(-0.7, -0.3, -0.5, -0.8),
                             y = c(7.5, 9.75, 9, 6.5))

good_satellites <- data.frame(x = c(1, -1, -0.3, 0.4),
                         y = c(7, 8, 10, 9.5))

bad_sats <- ggplot() +
  geom_emoji(data = receiver, mapping = aes(x = x, y = y), emoji = "1f697") +
  geom_hline(yintercept = -0.4, linewidth = 4, color = "gray30")+
  geom_emoji(data = bad_satellites, mapping = aes(x = x, y = y), emoji = "1f6f0")+
  geom_segment(data = bad_satellites, aes(x = 0, y = 0, xend = x, yend = y), linewidth = 0.2)+
  theme_void() +
  theme(panel.background = element_rect(fill = "lightblue1"))+
  scale_y_continuous(limits = c(-0.5, 10.5), expand = expansion(mult = c(0, 0), add = c(0, 0)))
bad_sats
```

```{r}
#| echo: false
#| fig-cap: "Good Satellite Geometry"

good_sats <- ggplot() +
  geom_emoji(data = receiver, mapping = aes(x = x, y = y), emoji = "1f697") +
  geom_hline(yintercept = -0.4, linewidth = 4, color = "gray30")+
  geom_emoji(data = good_satellites, mapping = aes(x = x, y = y), emoji = "1f6f0")+
  geom_segment(data = good_satellites, aes(x = 0, y = 0, xend = x, yend = y), linewidth = 0.2)+
  theme_void() +
  theme(panel.background = element_rect(fill = "lightblue1"))+
  scale_y_continuous(limits = c(-0.5, 10.5), expand = expansion(mult = c(0, 0), add = c(0, 0)))
good_sats

```
:::

## Dilution of Precision (DOP)

* Measure of GPS data quality.

* Different types include:

  - Position DOP (PDOP).
  
  - Horizontal DOP (HDOP).
  
  - Vertical DOP (VDOP).
  
## DOP Values and Data Quality

| **DOP Value**                 | <1   | 1 - 2     | 2 - 5    | 5 - 10   | 10 - 20 | >20 |
|-------------------|---------|---------|----------|----------|---------|---------|
| **Location Data Quality** | Ideal | Excellent | Very Good | Moderate | Fair    | Poor |

Scale relating the value of dilution of precision (DOP) coefficients to location data quality [@isikIntegrityAnalysisGPSBased2020].

## GPS Data Issues

* Poor GPS signal â†’ position errors.

* Position errors â†’ velocity errors â†’ acceleration errors.

* Low DOP doesn't always mean good quality GPS data.

## GPS Drift Example

PDOP values: 1.63 to 2.36 (Excellent to Very Good)

```{r}
#| echo: false
#| eval: true

data("nds_data")

nds_data_sf  <- nds_data |>
  st_as_sf(coords = c("gps_long", "gps_lat"), crs = "WGS84")

exdrive <- nds_data_sf |>
  filter(drive == 23)

exdrive_plot <- exdrive |>
  filter(time_utc >= ymd_hms("2019-05-28 21:17:20"), time_utc <= ymd_hms("2019-05-28 21:17:29"))

exdrive_plot <- exdrive_plot |>
  mutate(pt_label = c("Start", rep("", 8), "End"))

exdrive_bbox <- st_bbox(exdrive_plot)

exdrive_bbox_adj <- exdrive_bbox
exdrive_bbox_adj[1] <- exdrive_bbox_adj[1] - 0.0002
exdrive_bbox_adj[2] <- exdrive_bbox_adj[2] - 0.0002
exdrive_bbox_adj[3] <- exdrive_bbox_adj[3] + 0.0002
exdrive_bbox_adj[4] <- exdrive_bbox_adj[4] + 0.0002

# USGS data
data("oma_roads")
# Make exdrive example bounding box into sf object
exdrive_bbox_sf <- exdrive_bbox |>
  st_as_sfc() |>
  st_as_sf(crs = "WGS84")

# Find road candidates within the bounding box for the exdrive example above
poss_matches <- oma_roads |>
  st_filter(exdrive_bbox_sf, .predicate = st_intersects)

gps_drift_tmap <- tm_basemap(server = "CartoDB.VoyagerNoLabels") +
  tm_shape(poss_matches, bbox = exdrive_bbox_adj)+
  tm_lines(col = "tan", lwd = 10)+
  tm_shape(exdrive_plot, bbox = exdrive_bbox_adj)+
  tm_dots(size = 1, fill = "blue", fill_alpha = 0.9, 
          group = "original", group.control = "none")

gps_drift_tmap <- gps_drift_tmap +
  tm_shape(exdrive_plot, bbox = exdrive_bbox_adj)+
  tm_labels(text = "pt_label", xmod = 1.5, options = opt_tm_labels(point.label = FALSE))

gps_drift_tmap
```


# Map Matching

## Main Questions

1. Which road segment is the vehicle using?

2. Where exactly on the road segment is the vehicle?

## Existing Map Matching Methods

* Naive methods

* More advanced naive methods

* Hidden Markov models

* Etc.

## Map Matching Challenges

* True path is usually unknown

* Error quantification

* Outlier sensitivity

* Etc.

# Areas of Interest

## Visualizing Telematics Data

* Relating location in time and space to other variables 

* R package `DrivePlotR`

## Processing Telematics Data

* Map matching

* Correctly locating telematics data in space (latitude/longitude on correct part of the road system) and time

## Drawing Insights from Telematics Data

For example,

* Developing driving biomarkers for age-related cognitive decline in senior citizens

* Deriving the time to complete turning maneuvers at intersections

* Quantifying the influence of work zones, crashes, etc. on traffic flow

## References


